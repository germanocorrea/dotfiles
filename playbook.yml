---
- name: Configurar Estação de Trabalho
  hosts: localhost
  connection: local

  vars:
    dotfiles_dir: "{{ ansible_env.HOME }}/dotfiles"
    dotfiles_repo: "https://github.com/germanocorrea/dotfiles.git"

  tasks:
    # --- GRUPO: BASE (Pré-requisitos) ---
    - name: 1. Instalar pacotes base (Git, Stow)
      become: yes
      package: # Usando 'package' genérico para os pré-requisitos
        name:
          - git
          - stow
        state: present
      tags:
        - base
        - always # Sempre roda, pois é essencial

    - name: 2. Clonar repositório de dotfiles
      git:
        repo: "{{ dotfiles_repo }}"
        dest: "{{ dotfiles_dir }}"
        version: main
      tags:
        - base
        - always

    - name: 3. Instalar Yay (AUR Helper)
      tags:
        - aur
        #- always # Garantir que o yay exista antes de outros pacotes
      block:
        - name: 3a. Instalar dependências (git, base-devel)
          become: yes
          package:
            name:
              - git
              - base-devel
              - go
            state: present

        - name: 3b. Clonar repositório do yay para /tmp
          # Esta task roda como usuário normal (sem become: yes)
          ansible.builtin.git:
            repo: 'https://aur.archlinux.org/yay.git'
            dest: '/tmp/yay' # Usamos /tmp para não sujar o home
            clone: yes
            update: no # Só precisamos clonar, não atualizar

        - name: 3c. Construir e instalar o yay (makepkg)
          # Esta task TAMBÉM roda como usuário normal
          ansible.builtin.shell:
            # --noconfirm evita que o makepkg peça confirmação
            cmd: "makepkg -si --noconfirm"
            chdir: "/tmp/yay"
            # 'creates' é a chave para a idempotência:
            # Se o arquivo /usr/bin/yay já existir, o Ansible pula esta task.
            creates: "/usr/bin/yay"

    # --- GRUPO: PACOTES EM MASSA (Via YAY) ---
    # Usamos 'kewlfft.aur' que instala/usa 'yay' para
    # gerenciar pacotes do Repo e do AUR.
    # 'nvim', 'zsh', 'kitty', 'cosmic' foram removidos daqui
    # para serem tratados em suas próprias seções.

    - name: 4. Instalar Pacotes [development-base]
      become: yes
      package:
        name:
          - base
          - base-devel
          - curl
          - wget
          - zsh-autosuggestions
          - zsh-completions
          - cmake
          - gcc
          - speedtest-cli
          - tree-sitter
          - coreutils
          - go
          - jdk-openjdk
        state: present
      tags:
        - packages
        - development-base

    - name: 5. Instalar Pacotes [arch-base]
      become: yes
      package:
        name:
          - btop
          - buildah
          - podman
          - podman-compose
        state: present
      tags:
        - packages
        - arch-base

    - name: 6. Instalar Pacotes [personal]
      become: yes
      package:
        use: yay
        name:
          - solaar
          - android-file-transfer
          - calibre
          - distrobox
          - gimp
          - kdenlive
          - obs-studio
          - obsidian
          - vlc
        state: present
      tags:
        - packages
        - personal
    - name: 6. Instalar Pacotes (Yay) [personal]
      kewlfft.aur.aur:
        use: yay
        name:
          - zen-browser-bin
          - bibata-cursor-theme-bin
          - cable
          - pinta
          - stremio
        state: present
      tags:
        - packages
        - personal
        - aur

    - name: 7. Instalar Pacotes [g15]
      kewlfft.aur.aur:
        use: yay
        name:
          - dell-g15-controller
        state: present
      tags:
        - packages
        - g15

    - name: 8. Instalar Pacotes [graphics-base]
      become: yes
      package:
        name:
          - mesa
          - cuda
          - mesa-utils
        state: present
      tags:
        - packages
        - graphics-base

    # --- GRUPO: APLICATIVOS COM DOTFILES ---
    # Cada bloco instala o pacote E aplica o dotfile

    - name: Configurar Neovim
      tags:
        - nvim
        - development-base
      block:
        - name: Instalar pacote Neovim
          become: yes
          package:
            name: neovim
            state: present
          tags: packages # Também incluído na tag 'packages'

        - name: Aplicar (stow) dotfiles do Neovim
          command:
            cmd: "stow nvim"
            chdir: "{{ dotfiles_dir }}"
          tags: dotfiles # Também incluído na tag 'dotfiles'

    - name: Configurar Zsh
      tags:
        - zsh
        - development-base
      block:
        - name: Instalar pacote Zsh
          become: yes
          package:
            name: zsh
            state: present
          tags: packages

        - name: Aplicar (stow) dotfiles do Zsh
          command:
            # Assumindo que seu diretório stow se chama 'zsh'
            cmd: "stow zsh"
            chdir: "{{ dotfiles_dir }}"
          tags: dotfiles

    - name: Configurar Kitty
      tags:
        - kitty
        - personal
      block:
        - name: Instalar pacote Kitty
          become: yes
          package:
            name: kitty
            state: present
          tags: packages

        - name: Aplicar (stow) dotfiles do Kitty
          command:
            cmd: "stow kitty"
            chdir: "{{ dotfiles_dir }}"
          tags: dotfiles

    - name: Configurar Cosmic
      tags:
        - cosmic
        - personal
      block:
        - name: Instalar pacote Cosmic
          become: yes
          package:
            name: cosmic
            state: present
          tags: packages

        - name: Aplicar (stow) dotfiles do Cosmic
          command:
            cmd: "stow --adopt cosmic"
            chdir: "{{ dotfiles_dir }}"
          tags: dotfiles
    
    - name: Instalar Haskell (GHCup)
      tags:
        - development-base
        - haskell
      block:
        - name: Baixar e instalar GHCup (Não-Interativo)
          ansible.builtin.shell:
            cmd: "curl --proto '=https' --tlsv1.2 -sSf https://get-ghcup.haskell.org | sh"
            # Isso faz o Ansible pular a task se o arquivo já existir
            creates: "{{ ansible_env.HOME }}/.ghcup/bin/ghcup"
          environment:
            # Esta é a variável que "responde" às perguntas do script
            BOOTSTRAP_HASKELL_NONINTERACTIVE: "1"
    # ... (tasks anteriores)

    - name: Instalar Rust (Rustup)
      tags:
        - development-base
        - rust
      block:
        - name: Baixar e instalar Rustup (Não-Interativo)
          ansible.builtin.shell:
            # O 'sh -s -- -y' passa a flag '-y' para o script de instalação
            cmd: "curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y"
            # 'creates' torna a task idempotente, verificando se o binário já existe
            creates: "{{ ansible_env.HOME }}/.cargo/bin/rustup"

    - name: Instalar NVM (Node Version Manager)
      tags:
        - nvm
        - development-base
      block:
        - name: Baixar e instalar NVM
          ansible.builtin.shell:
            # Usamos a versão específica que você forneceu
            cmd: "curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.40.3/install.sh | bash"
            # 'creates' torna a task idempotente
            creates: "{{ ansible_env.HOME }}/.nvm"

